<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拾音距离计算器 Pro (界面优化)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Styles remain the same as the Sci-Fi "Pro" version */
        :root {
            --sci-fi-bg: #0a0f1a; /* Deep space blue */
            --sci-fi-bg-gradient: linear-gradient(135deg, #0d121f 0%, #1a0a1f 100%);
            --sci-fi-card-bg: rgba(15, 23, 42, 0.75); /* Semi-transparent dark slate blue */
            --sci-fi-primary: #00e5ff; /* Bright Cyan */
            --sci-fi-accent: #ff6f00; /* Bright Orange accent */
            --sci-fi-text: #e0f7fa; /* Light Cyan text */
            --sci-fi-text-muted: #b0bec5; /* Muted blue-gray */
            --sci-fi-border: rgba(0, 229, 255, 0.3); /* Faint cyan border */
            --sci-fi-glow: 0 0 12px rgba(0, 229, 255, 0.5);
            --sci-fi-glow-accent: 0 0 12px rgba(255, 111, 0, 0.6);
            --sci-fi-font: 'Exo 2', 'Noto Sans SC', sans-serif; /* Sci-fi font + fallback */
        }
        body {
            background-color: var(--sci-fi-bg);
            background-image: var(--sci-fi-bg-gradient);
            color: var(--sci-fi-text);
            padding-top: 2rem;
            padding-bottom: 2rem;
            font-family: var(--sci-fi-font);
            min-height: 100vh;
        }
        .card {
            background-color: var(--sci-fi-card-bg);
            border: 1px solid var(--sci-fi-border);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), var(--sci-fi-glow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
             box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 229, 255, 0.7);
        }
        h1 {
             font-weight: 700;
             color: var(--sci-fi-primary);
             text-shadow: 0 0 8px rgba(0, 229, 255, 0.7);
        }
        .form-label {
            font-weight: 500;
            color: var(--sci-fi-text);
            letter-spacing: 0.5px;
        }
        .form-control, .form-select {
            background-color: rgba(10, 15, 30, 0.8);
            color: var(--sci-fi-text);
            border: 1px solid var(--sci-fi-border);
            border-radius: 0.5rem;
            padding: 0.8rem 1rem;
             transition: border-color 0.3s, box-shadow 0.3s;
        }
         .form-control::placeholder {
             color: var(--sci-fi-text-muted) !important;
             opacity: 0.8;
         }
        .form-control:focus, .form-select:focus {
            background-color: rgba(10, 15, 30, 0.9);
            color: var(--sci-fi-text);
            border-color: var(--sci-fi-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 229, 255, 0.25), inset 0 0 5px rgba(0, 229, 255, 0.2);
            outline: none;
        }
        .input-group-text { /* Keep styling for sensitivity unit */
            background-color: rgba(10, 15, 30, 0.8);
            border: 1px solid var(--sci-fi-border);
            color: var(--sci-fi-text-muted);
            border-left: none;
             border-radius: 0 0.5rem 0.5rem 0;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2300e5ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--sci-fi-primary), var(--sci-fi-accent));
            border: none;
            color: #0a0f1a;
            font-weight: 700;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
            letter-spacing: 1px;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 229, 255, 0.5), 0 0 10px var(--sci-fi-accent);
            background: linear-gradient(45deg, var(--sci-fi-accent), var(--sci-fi-primary));
             color: #0a0f1a;
        }
         .btn-primary:disabled {
             background: rgba(var(--bs-secondary-rgb), 0.3);
             box-shadow: none;
             cursor: not-allowed;
             color: var(--sci-fi-text-muted);
         }
        .result-box {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--sci-fi-border);
            background-color: rgba(10, 15, 30, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none;
            animation: fadeInResult 0.5s ease-out;
            box-shadow: var(--sci-fi-glow);
        }
         @keyframes fadeInResult {
             from { opacity: 0; transform: translateY(20px); }
             to { opacity: 1; transform: translateY(0); }
         }
        .result-box h5 {
             color: var(--sci-fi-primary);
             font-weight: 700;
             margin-bottom: 1rem;
        }
         #distanceResult strong {
             color: var(--sci-fi-accent);
             font-size: 1.3em;
         }
        .calculation-details {
            font-size: 0.85em;
            color: var(--sci-fi-text-muted);
            border-top: 1px solid var(--sci-fi-border);
            padding-top: 1rem;
            margin-top: 1rem;
        }
         .calculation-details p { margin-bottom: 0.3rem; }
         .form-text {
            color: var(--sci-fi-text-muted) !important;
            font-size: 0.85em;
         }
        /* Validation Styles */
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: var(--bs-danger);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-danger-rgb), 0.25);
        }
         .form-control.is-valid, .form-select.is-valid {
            border-color: var(--bs-success);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-success-rgb), 0.25);
         }
          .alert-danger {
               background-color: rgba(var(--bs-danger-rgb), 0.2);
               color: var(--bs-danger-color);
               border-color: rgba(var(--bs-danger-rgb), 0.4);
          }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card p-4 p-md-5">
                    <h1 class="text-center mb-4"><i class="fas fa-broadcast-tower me-2"></i> 拾音距离计算器 Pro</h1>
                    <form id="micDistanceForm">

                        <div class="mb-4">
                            <label for="sensitivity" class="form-label"><i class="fas fa-sliders-h me-2"></i>话筒灵敏度</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="sensitivity" step="any" placeholder="例如 -40 或 10" required>
                                <select class="form-select flex-grow-0" id="sensitivityUnit" style="width: auto;">
                                    <option value="dbv">dBV/Pa</option>
                                    <option value="mv">mV/Pa</option>
                                </select>
                            </div>
                            <div class="form-text">例如 -40 dBV/Pa ≈ 10 mV/Pa</div>
                        </div>

                        <div class="mb-4">
                            <label for="sourceLevel" class="form-label"><i class="fas fa-volume-up me-2"></i>声源声压 (Pa)</label>
                            <input type="number" class="form-control" id="sourceLevel" step="any" placeholder="例如 0.5" required>
                            <div class="form-text">1 Pa ≈ 94 dB SPL (参考20 μPa)</div>
                        </div>

                        <div class="mb-4">
                             <label for="noiseLevel" class="form-label"><i class="fas fa-volume-down me-2"></i>环境噪声 (dB SPL)</label>
                             <input type="number" class="form-control" id="noiseLevel" step="any" placeholder="例如 30" required>
                             <div class="form-text">参考值：安静房间 30-40 dB，普通办公室 50-60 dB</div>
                        </div>

                        <div class="mb-4">
                            <label for="requiredSnr" class="form-label"><i class="fas fa-signal me-2"></i>信噪比 (dB)</label>
                             <input type="number" class="form-control" id="requiredSnr" step="any" placeholder="例如 60" required>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="calculateBtn" disabled>
                                <i class="fas fa-calculator me-2"></i> 计算
                            </button>
                        </div>
                    </form>

                    <div id="result" class="result-box mt-4">
                        <h5 class="text-center">计算结果</h5>
                        <p id="distanceResult" class="text-center fs-4 mb-3"></p>
                        <div class="calculation-details text-center small">
                             <p id="detailSensitivity" class="mb-1"></p>
                             <p id="detailSource" class="mb-1"></p>
                             <p id="detailNoise" class="mb-1"></p>
                             <p id="detailSnr" class="mb-1"></p>
                        </div>
                         <hr style="border-color: var(--sci-fi-border); opacity: 0.5;">
                         <p class="text-center small text-muted mb-0">
                             注意: 使用修正后的公式 (逆距离定律) 计算。结果为理论值。
                         </p>
                    </div>
                     <div id="error" class="alert alert-danger mt-3 d-none" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript remains exactly the same as the previous "Pro" version adapted to the image layout
        const form = document.getElementById('micDistanceForm');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const distanceResultP = document.getElementById('distanceResult');
        // Detail paragraphs
        const detailSensitivityP = document.getElementById('detailSensitivity');
        const detailSourceP = document.getElementById('detailSource');
        const detailNoiseP = document.getElementById('detailNoise');
        const detailSnrP = document.getElementById('detailSnr');

        // --- Constants ---
        const REFERENCE_PRESSURE_PA = 0.00002; // 20 µPa

        // --- Input Elements ---
        const sensitivityInput = document.getElementById('sensitivity');
        const sensitivityUnitSelect = document.getElementById('sensitivityUnit');
        const sourceLevelInput = document.getElementById('sourceLevel'); // Now Pa only
        const noiseLevelInput = document.getElementById('noiseLevel');   // Now mV only
        const requiredSnrInput = document.getElementById('requiredSnr');   // Now dB only

        // --- Input Validation ---
         const inputsToValidate = [
             sensitivityInput, sourceLevelInput, noiseLevelInput, requiredSnrInput
         ];

         function validateInput(inputElement) {
              const value = inputElement.value;
              const parsedValue = parseFloat(value);
              let isValid = value.trim() !== '' && !isNaN(parsedValue);

              if (isValid) {
                   const unitSelect = form.querySelector(`#${inputElement.id}Unit`); // Only exists for sensitivity now
                   const unit = unitSelect ? unitSelect.value : null;

                   if (inputElement.id === 'sensitivity') {
                       if (unit === 'mv' && parsedValue <= 0) isValid = false;
                   } else if (inputElement.id === 'sourceLevel') { // Pa, must be positive
                       if (parsedValue <= 0) isValid = false;
                   } else if (inputElement.id === 'noiseLevel') { // mV, must be positive
                        if (parsedValue <= 0) isValid = false;
                   }
              }

              inputElement.classList.remove('is-valid', 'is-invalid');
              if (value.trim() !== '') {
                   inputElement.classList.add(isValid ? 'is-valid' : 'is-invalid');
              }
              checkFormValidity();
         }

         function checkFormValidity() {
              const allValid = inputsToValidate.every(input => {
                  const value = input.value;
                  const parsedValue = parseFloat(value);
                  let isValid = value.trim() !== '' && !isNaN(parsedValue);
                  if(isValid) {
                      const unitSelect = form.querySelector(`#${input.id}Unit`);
                      const unit = unitSelect ? unitSelect.value : null;
                      if (input.id === 'sensitivity' && unit === 'mv' && parsedValue <= 0) isValid = false;
                      else if (input.id === 'sourceLevel' && parsedValue <= 0) isValid = false; // Pa check
                      else if (input.id === 'noiseLevel' && parsedValue <= 0) isValid = false; // mV check
                  }
                  return isValid;
              });
              calculateBtn.disabled = !allValid;
         }

         inputsToValidate.forEach(input => {
             input.addEventListener('input', () => validateInput(input));
             if (input.id === 'sensitivity') {
                 const unitSelect = form.querySelector(`#${input.id}Unit`);
                 unitSelect.addEventListener('change', () => validateInput(input));
             }
         });

        // --- Calculation Logic ---
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            if (calculateBtn.disabled) return;

            resultDiv.style.display = 'none';
            errorDiv.classList.add('d-none');
            errorDiv.textContent = '';

            try {
                // 1. Get values and units (Units assumed for source/noise)
                const sensitivity = parseFloat(sensitivityInput.value);
                const sensitivityUnit = sensitivityUnitSelect.value;
                const sourcePressurePa = parseFloat(sourceLevelInput.value); // Input is now directly Pa
                const noiseLevelDb = parseFloat(noiseLevelInput.value);     // Input is now in dB SPL
                const requiredSnr = parseFloat(requiredSnrInput.value);

                // 2. Normalize Sensitivity to mV/Pa (same)
                let sensitivityMvPa;
                let sensDetail;
                if (sensitivityUnit === 'dbv') {
                    const sensitivityV = Math.pow(10, sensitivity / 20);
                    sensitivityMvPa = sensitivityV * 1000;
                    sensDetail = `${sensitivity} dBV/Pa (≈ ${sensitivityMvPa.toFixed(2)} mV/Pa)`;
                } else {
                    sensitivityMvPa = sensitivity;
                    sensDetail = `${sensitivity} mV/Pa`;
                }
                if (sensitivityMvPa <= 0) throw new Error("灵敏度计算结果必须为正。");

                // 3. Calculate noise voltage
                const noiseVoltageMv = sensitivityMvPa * (Math.pow(10, (noiseLevelDb - 94) / 20) * 1); // Convert dB SPL to Pa then to mV

                // 4. Source Level is already Pa (No conversion needed)
                let sourceDetail = `声源(@1m): ${sourcePressurePa.toFixed(3)} Pa`;
                if (sourcePressurePa <= 0) throw new Error("声源声压必须为正。");

                // 4. Calculate Signal Voltage at 1m (Base Voltage) (same)
                const baseVoltageMv = sensitivityMvPa * sourcePressurePa;
                if (baseVoltageMv <= 0 || !isFinite(baseVoltageMv)) throw new Error("计算出的基础信号电压无效。");

                // 5. Noise Voltage is already mV (No conversion needed)
                let noiseDetail = `噪声: ${noiseLevelDb.toFixed(1)} dB SPL (≈ ${noiseVoltageMv.toFixed(3)} mV)`;
                if (noiseVoltageMv <= 0) throw new Error("环境噪声电压必须为正。");

                // 6. Calculate Minimum Required Signal Voltage (same formula)
                const minSignalVoltageMv = noiseVoltageMv * Math.pow(10, requiredSnr / 20);
                let snrDetail = `SNR要求: ${requiredSnr} dB => 最小信号 ${minSignalVoltageMv.toExponential(3)} mV (噪声 ${noiseVoltageMv.toExponential(3)} mV)`;
                if (minSignalVoltageMv <= 0 || !isFinite(minSignalVoltageMv)) throw new Error("计算出的最低信号电压要求无效。");

                // 7. Calculate Max Distance (Using Inverse Square Law)
                // 根据逆平方定律：声压与距离的平方成反比，电压与声压成正比
                // 因此在1米处的电压与距离d米处的电压比值为：baseVoltageMv/minSignalVoltageMv = d^2
                // 所以d = √(baseVoltageMv/minSignalVoltageMv)
                let maxDistanceMeters = Math.sqrt(baseVoltageMv / minSignalVoltageMv);

                // 8. Format and Display Results (same)
                let distanceText;
                 if (maxDistanceMeters <= 0 || !isFinite(maxDistanceMeters)) {
                     distanceText = "无法达到要求 (距离 ≤ 0 或无效)";
                     maxDistanceMeters = 0;
                  } else if (maxDistanceMeters > 10000) {
                      distanceText = `> 10 km (理论值: ${maxDistanceMeters.toFixed(1)} m)`;
                  }
                  else {
                     const maxDistanceCm = Math.round(maxDistanceMeters * 100);
                     distanceText = `<span style="color: var(--sci-fi-primary)"><strong>${maxDistanceCm}</strong> cm (${maxDistanceMeters.toFixed(2)} m)</span>`;
                  }

                distanceResultP.innerHTML = `<span style="color: var(--sci-fi-primary)">理论最大拾音距离</span> <span style="color: var(--sci-fi-primary)">≈</span> ${distanceText}`;
                detailSensitivityP.textContent = `灵敏度: ${sensDetail}`;
                detailSourceP.textContent = ` ${sourceDetail}`;
                detailNoiseP.textContent = ` ${noiseDetail}`;
                detailSnrP.textContent = ` ${snrDetail}`;

                resultDiv.style.display = 'block';
                resultDiv.style.animation = 'none';
                void resultDiv.offsetWidth;
                resultDiv.style.animation = 'fadeInResult 0.5s ease-out';

            } catch (error) {
                console.error("Calculation Error:", error);
                errorDiv.textContent = `计算错误: ${error.message || '请检查输入值。'}`;
                errorDiv.classList.remove('d-none');
            }
        });

        // Initial setup
        checkFormValidity();

    </script>
</body>
</html>